/*! Pulp Toolkit - v0.1.0 - 2012-08-30
* https://github.com/sjockers/pulp
* Copyright (c) 2012 Simon Jockers; Licensed MIT */
(function(e,t){"use strict";function i(){return t("link[rel='toc']").attr("href")}function s(){return t("link[rel='templates']").attr("href")}var n=new e.util.Module;n.extend(e.util.observable);var r=e.model.articles;n.extend({init:function(r,o){var u=r||i(),a=o||s();t.ajax({type:"GET",dataType:"html",url:a,success:function(r){t(document.body).append(r),e.model.observe(e.events.TOC_LOADED,n.setup),e.model.getToc(u)}})},setup:function(){var t=window.location.pathname;n.navigate(t),e.ui.navbar.init()},historySupported:function(){return!!window.history&&!!window.history.pushState},updateHistory:function(){var e=r.current();window.document.title=e.title,this.historySupported()&&history.pushState(null,null,e.url)},nextArticle:function(){r.forward(),e.app.updateHistory()},previousArticle:function(){r.backward(),e.app.updateHistory()},navigate:function(t){e.ui.carousel.display(t)}}),e.app=e.app||n})(window.pulp=window.pulp||{},jQuery),function(e,t){"use strict";var n=new e.util.Module;n.include(e.util.observable),n.include({init:function(e){e=e||{},this.url=e.url,this.title=e.title,this.thumbnail=e.thumbnail,this.byline=e.byline,this.content=e.content},save:function(){localStorage.setItem(this.url,JSON.stringify(this.content))},load:function(){this.content=JSON.parse(localStorage.getItem(this.url))},fetch:function(r){function s(t){i.content=n.extractContent(t),i.save(),i.notify(e.events.CONTENT_LOADED),typeof r=="function"&&r()}var i=this;i.load(),i.content?i.notify(e.events.CONTENT_LOADED):t.ajax({type:"GET",dataType:"html",url:this.url,success:s})}}),n.extend({extractContent:function(e){var n=e.replace(/\s*\n\s*/g," ");return n=n.split(/<\/?body[^>]*>/)[1],t(n).find("#pulp").html()}}),e.Article=e.Article||n}(window.pulp=window.pulp||{},jQuery),function(e,t){"use strict";e.events={TOC_LOADED:"TOC loaded!",CONTENT_LOADED:"Content loaded!"}}(window.pulp=window.pulp||{},jQuery),function(e,t){"use strict";function r(e,n,r){t.ajax({type:"GET",url:e,success:function(e,t,r){typeof n=="function"&&n(e)},error:function(e,t,n){typeof r=="function"&&r(n)}})}function i(n){var r=t(n).find("[itemscope]"),i=t.map(r,function(n){var r=t(n);return new e.Article({title:r.find("[itemprop='title']").text(),url:r.find("[itemprop='url']").attr("href"),byline:r.find("[itemprop='byline']").text()})});return i}var n=new e.util.Module;n.extend(e.util.observable),n.articles=new e.util.Collection,n.getToc=function(t){function s(t){var r=i(t);n.articles.init(r),n.notify(e.events.TOC_LOADED)}function o(t){e.log("Table of contents could not be loaded!",t)}r(t,s,o)},e.model=e.model||n}(window.pulp=window.pulp||{},jQuery),function(e,t){var n=new e.util.Module;n.include(e.util.observable),n.include(e.util.renderable),n.include({article:null,init:function(t,n){if(!t||!n)return;var r=this;r.article=t,r.article.observe(e.events.CONTENT_LOADED,function(){r.create("view_tmp",r.article),r.render(n),r.article.unObserve(e.events.CONTENT_LOADED,this)}),r.article.fetch()},render:function(e){this.target=e||this.target,t(this.target).html(this.$element)},replaceWith:function(t){e.log(t.$element),this.$element.replaceWith(t.$element.html())}});var r={create:function(e,t){return new n(e,t)}};e.articleViewFactory=e.articleViewFactory||r}(window.pulp=window.pulp||{},jQuery),function(e,t){function o(){function n(){return window.location=this.getAttribute("href"),!1}var e=document.getElementsByTagName("a"),t;for(t=0;t<e.length;t++)!e[t].onclick&&e[t].getAttribute("target")!=="_blank"&&(e[t].onclick=n)}function u(){t("#slider").height(t(document).height()),n.scroller.refresh(),n.slider.refresh(),n.slider.center()}function a(e){return{previous:t(e).find(".previous"),current:t(e).find(".current"),next:t(e).find(".next")}}function f(){if(s===!1){e.app.nextArticle();var t=a(n.slider.scroller);r.hasNext()?(e.articleViewFactory.create(r.next(),t.previous),t.next.removeClass("next").addClass("current"),t.current.removeClass("current").addClass("previous"),t.previous.removeClass("previous").addClass("next"),n.slider.center(),n.scroller.destroy(),n.scroller=new e.util.Scroll(t.next.get(0)),i=!1):s===!1&&(e.app.previousArticle(),e.articleViewFactory.create(r.previous(),t.previous),n.scroller=new e.util.Scroll(t.next.get(0)),s=!0)}}function l(){if(i===!1){e.app.previousArticle();var t=a(n.slider.scroller);r.hasPrevious()?(e.articleViewFactory.create(r.previous(),t.next),t.previous.removeClass("previous").addClass("current"),t.current.removeClass("current").addClass("next"),t.next.removeClass("next").addClass("previous"),n.slider.center(),n.scroller.destroy(),n.scroller=new e.util.Scroll(t.previous.get(0)),s=!1):i===!1&&(e.app.nextArticle(),e.articleViewFactory.create(r.next(),t.next),n.scroller=new e.util.Scroll(t.previous.get(0)),i=!0)}}function c(e){switch(n.slider.currPageX){case 0:l();break;case 2:f()}}function h(){n.create("carousel_tmpl"),n.target=document.body,n.hideContent(),n.render(),n.slider=new e.util.Scroll("pulp-carousel",{snap:!0,momentum:!1,hScrollbar:!1,vScroll:!1,lockDirection:!0,onScrollEnd:c}),t(window).bind("orientationchange resize",function(){u()}),o()}var n=new e.util.Module;n.extend(e.util.renderable),n.extend(e.util.observable);var r=e.model.articles,i=!1,s=!1;n.extend({scroller:null,slider:null,init:function(){},display:function(t){this.element||h(),r.find("url",t);var i=a(this.slider.scroller);e.articleViewFactory.create(r.current(),i.current),n.scroller=new e.util.Scroll(i.current.get(0)),r.hasPrevious()&&e.articleViewFactory.create(r.previous(),i.previous),r.hasNext()&&e.articleViewFactory.create(r.next(),i.next),u()},forward:function(){this.slider.scrollToPage("next",0)},backward:function(){this.slider.scrollToPage("prev",0)}}),e.ui=e.ui||{},e.ui.carousel=e.ui.carousel||n}(window.pulp=window.pulp||{},jQuery),function(e,t){"use strict";function r(t){e.ui.carousel.forward()}function i(t){e.ui.carousel.backward()}var n=new e.util.Module;n.extend(e.util.renderable),n.extend({init:function(){n.create("navbar_tmp"),n.render("body"),t(".pulp-prev").click(i),t(".pulp-next").click(r)}}),e.ui=e.ui||{},e.ui.navbar=e.ui.navbar||n}(window.pulp=window.pulp||{},jQuery),function(e,t){"use strict";e.util=e.util||{},e.util.Collection=function(){var e=0,t=[];return{init:function(e){this.clear(),t=e},add:function(e){t.push(e)},find:function(n,r){var i=t.length;while(i>0){i--;if(t[i][n]===r)return e=i,t[i]}return null},current:function(){return this.hasItems()?t[e]:null},next:function(){return this.hasNext()?t[e+1]:null},previous:function(){return this.hasPrevious()?t[e-1]:null},backward:function(){return this.hasPrevious()?(e-=1,t[e]):null},forward:function(){return this.hasNext()?(e+=1,t[e]):null},rewind:function(){e=0},clear:function(){e=0,t=[]},hasItems:function(){return t.length>0},hasNext:function(){return e+1<t.length},hasPrevious:function(){return e>0}}}}(window.pulp=window.pulp||{},jQuery),function(e){"use strict";e.log=function(){e.log.history=e.log.history||[],e.log.history.push(arguments),window.console&&(arguments.length===1?console.debug(arguments.shift):console.log(Array.prototype.slice.call(arguments)))}}(window.pulp=window.pulp||{}),function(e,t){"use strict";var n=function(e){var t=function(){this.init.apply(this,arguments)};t.extend=function(e){var n,r=e.extended;for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);r&&r(t)},t.include=function(e){var n,r=e.included;for(n in e)e.hasOwnProperty(n)&&(t.prototype[n]=e[n]);r&&r(t)},t.proxy=function(e){var t=this;return function(){return e.apply(t,arguments)}},t.clone=function(e){return typeof e=="function"?e:typeof e!="object"?e:jQuery.isArray(e)?jQuery.extend([],e):jQuery.extend({},e)},t.prototype.init=function(){};if(e){for(var n in e)t[n]=t.clone(e[n]);for(var r in e.prototype)t.prototype[r]=t.clone(e.prototype[r]);t._super=e,t.prototype._super=e.prototype}return t.prototype.proxy=t.proxy,t.prototype._class=t,t};e.util=e.util||{},e.util.Module=n}(window.pulp=window.pulp||{},jQuery),function(e,t){function n(e,t){return e.observers||(e.observers={}),e.observers[t]||(e.observers[t]=[]),e.observers[t]}function r(e,t){this.observers||(this.observers=[]);if(typeof t!="function")throw new TypeError("not a function");if(typeof e!="string")throw new TypeError("not a valid event identifier");n(this,e).push(t)}function i(e,t){if(typeof t!="function")throw new TypeError("not a function");if(typeof e!="string")throw new TypeError("not a valid event identifier");var r=n(this,e);for(var i=0,s=r.length;i<s;i++)r[i]===t&&r.splice(i,1)}function s(e,r){var i=n(this,e);return t.inArray(r,i)>=0}function o(e){if(typeof e!="string")throw new TypeError("not a valid event identifier");var r=n(this,e),i=Array.prototype.slice.call(arguments,1);t.each(r,function(){this.apply(this,i)})}e.util=e.util||{},e.util.observable={observe:r,unObserve:i,hasObserver:s,notify:o}}(window.pulp=window.pulp||{},jQuery),function(e,t){"use strict";e.util=e.util||{},e.util.renderable={element:null,$element:null,target:null,data:{},template:null,create:function(n,r){this.template=n||this.template,this.data=r||this.data,this.element=e.util.templating(this.template,this.data),this.$element=t(this.element)},render:function(e){this.target=e||this.target,t(this.target).append(this.$element)},hideContent:function(n){this.target=n||this.target,t(this.target).wrapInner(e.util.templating("original_tmp",{}))}};var n={};e.util.templating=function(t,r){var i=/\W/.test(t)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+t.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):n[t]=n[t]||e.util.templating(document.getElementById(t).innerHTML);return r?i(r):i}}(window.pulp=window.pulp||{},jQuery),function(e,t){"use strict";iScroll.prototype.center=function(){this.pagesX&&(this._pos(this.pagesX[1],0),this.currPageX=1)},e.util=e.util||{},e.util.Scroll=iScroll}(window.pulp=window.pulp||{},jQuery);